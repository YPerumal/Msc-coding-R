---
title: 'R Notebook'
output:
  html_document:
    df_print: paged
---


```{r}
# library imports
library(tidyverse)
library(gridExtra)
library(Amelia)
```

### Import Data
```{r}
df <- read.csv('/Users/yevashanperumal/Library/CloudStorage/GoogleDrive-chopsuey8918@gmail.com/My Drive/Yevashan Perumal MSc v2/Data/data with some cdw.csv')
```

```{r}
head(df)
```

```{r}
dim(df)
```


Drop the unnecessary columns
```{r}
cols_to_drop <- c('RecordID','ProductCode','DimGCSPartyKeyLifeCovered'
                  ,'DimDateKeyInitiated','DimDateKeyFinalised','DimDateKeyAccepted'
                  ,'UnderwritingInitiationDate','UnderwritingFinaliseDate',
                  'UnderwritingCode','UnderwritingTerritory',
                  'UnderwritingDuration','QuoteNumber' ,
                  # because of high correlation/target leakage/they're informed by GammaGT
                  'LoadingPercentage','CoverLoadingAmount','HealthLoadingPercentage',
                  'CoverLoading','HealthLoadingIndicator','CoverLoadingIndicator',# double check these are all for current app?could be previous
                  'UnderwritingOutcome','NoOfLoadingsApplied',
                   'LifeCoveredClientID'  #customer identifier
                  )

#drop columns
df2 <- df %>% select(-all_of(cols_to_drop))

#remove duplicate rows
df2 <- df2 %>% distinct()

dim(df2)
```

```{r}
str(df2)
```
Lots of numeric values coming through as characters; More nulls will likely be introduced when I convert them

```{r}
char_to_numeric_list <- c( 
'CurrentCoverAmount','CholesterolValue','GammaGTValue','CotinineValue',
'BloodSugarValue','ClientBMIValue','DoctorBMIValue','SystolicBloodPressureValue',
'DiastolicBloodPressureValue','RestingPulseValue','HeightValue','WeightValue',
'NumberOfCigarettes','NumberOfFailedLevel1Evaluations','NumberOfFailedDetailEvaluations','NumberOfExclusions',    
'NumberOfVerifications','NumberOfDeferrals','MonthlyIncome','MonthlyIncome_Override',
'UnderwritingCreditAmount','InputMedium','CoverAmount',
'PremiumRateCatDiscount','ReinsuranceRateCatDiscount','IntermediaryQualityDiscount','ManualDiscountIndicator',  
'MonthlyIncome_Override2','AGE','ALL_BEN_COUNT','ALL_CONTRACT_COUNT','ANNUAL_INVESTMENT','AUM'
)            
df2 <- df2 %>% mutate_at(char_to_numeric_list, as.numeric)
```

```{r}
missmap(df2)
```


```{r}
colSums(is.na(df2))

```
Couple columns I could def drop(or maybe need to check vals before numeric conversion):
- ManualDiscountIndicator
- NumberOfVerifications
- CotinineValue
- InputMedium

Some missing values for GammaGT;
Some with like 50% missing. Maybe need to leave those out too. 

```{r}
# Unique values for all variables in the dataframe

# tab1 <- df2 %>% summarise_all(n_distinct)%>%t()
# tab1 <- data.frame(tab1)
# tab1 %>% arrange(tab1)
```
# Univariate exploration

## Numeric Variables (and ones that should be)

```{r}
box_and_hist <- function(variable){
    hist <- df2%>%ggplot(aes_string(x=variable))+geom_histogram()+
            theme(axis.title.x=element_blank(),
                  axis.title.y = element_text(size = 6),
                  plot.title = element_text(size = 8))+
            labs(title = paste('Histogram and Boxplot of',variable))
    boxp <- df2%>%ggplot()+
      geom_boxplot(aes_string(x=variable))+
      theme(axis.title.x = element_text(size =8))
    grid.arrange(hist,boxp,nrow=2)
    
    summary(df2 %>% select(variable))
}

# add option to create a filtered view?
```


```{r}
countplot_explore <- function(input_variable){
    bar <- df2%>%ggplot(aes_string(x=input_variable))+geom_bar()+
      labs(title = paste('Countplot of ',input_variable))
    bar
    # summary(df2 %>% select(variable))
}

# add option to create a filtered view?
```

```{r}
countplot_explore(input_variable='SmokerStatus')
```

```{r message=FALSE, warning=FALSE}
num_cols <- df2 %>% select_if(is.numeric) %>% colnames()
```

```{r}
num_cols[1]
```


```{r}
# CurrentCoverAmount
box_and_hist(num_cols[1])
```

# Target Variable
```{r}
df2$GammaGTValue <-  as.integer(df2$GammaGTValue)
df2 %>% filter(GammaGTValue<200) %>%  ggplot(aes(x=GammaGTValue))+geom_histogram(binwidth = 10)
```
Some really weird large outliers than need to be taken care of.
Also some NAs introduced when converting to character.

# Preprocessing steps
- drop unused columns
- remove duplicate rows
- convert character columns to numeric
- convert indicator columns to factors;

```{r}

```

